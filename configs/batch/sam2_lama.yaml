# Batch Processing Configuration: SAM2 Segmentation + LaMa Inpainting
# Auto-discovers films and processes them sequentially
#
# Usage:
#   python scripts/batch/batch_processor.py --config configs/batch/sam2_lama.yaml --resume

discovery:
  base_dir: "/mnt/data/ai_data/datasets/3d-anime"
  film_pattern: "*"  # Glob pattern for film directories
  exclude:
    - "luca"  # Already processed manually

jobs:
  # Job 1: SAM2 Instance Segmentation
  - name: "sam2_segmentation"
    script: "scripts/generic/segmentation/instance_segmentation.py"
    conda_env: "ai_env"

    args:
      # Positional argument (frames directory)
      template: "{frames_dir}"

      # Named arguments
      named:
        --output-dir: "{base_dir}/{film}/{film}_instances_sam2_v2"
        --model: "sam2_hiera_large"
        --device: "cuda"
        --min-size: "4096"
        --save-masks: null  # Flag without value
        --save-backgrounds: null
        --context-mode: "transparent"

    completion_check:
      type: "backgrounds_complete"
      path: "{base_dir}/{film}/{film}_instances_sam2_v2/backgrounds"
      frames_dir: "{frames_dir}"
      tolerance: 0.95  # 95% of frames must be processed

    resources:
      gpu: true
      estimated_time_per_frame: 13.4  # seconds (based on Luca processing)

    retry:
      max_attempts: 3
      backoff_seconds: 120  # 2 minutes between retries

  # Job 2: LaMa Inpainting
  - name: "lama_inpainting"
    script: "scripts/generic/inpainting/sam2_background_inpainting.py"
    conda_env: "ai_env"
    depends_on: "sam2_segmentation"  # Wait for SAM2 to complete

    args:
      named:
        --sam2-dir: "{base_dir}/{film}/{film}_instances_sam2_v2"
        --output-dir: "{base_dir}/{film}/backgrounds_lama_v2"
        --method: "lama"
        --batch-size: "8"
        --device: "cuda"
        --mask-dilate: "20"

    completion_check:
      type: "file_exists"
      path: "{base_dir}/{film}/backgrounds_lama_v2/inpainting_metadata.json"

    resources:
      gpu: true
      estimated_time_per_image: 2.5  # seconds

    retry:
      max_attempts: 2
      backoff_seconds: 60

execution:
  mode: "sequential"  # Process one film at a time (GPU constraint)
  log_dir: "logs/batch_processing"
  resume: true  # Resume from last incomplete job
  save_progress: true
  progress_file: "progress.json"
